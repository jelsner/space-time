---
title: "Ian's World"
author: "Ian and Jim"
output:
  html_document:
editor_options: 
  chunk_output_type: console
---

Packages
```{r}
library(dplyr)
library(tmap)
library(sf)
library(lubridate)
library(rnaturalearth)
```

Get data from Ian's private location tracking server for June 15, 2019. Changed to hosted file to hide API key.
```{r}
L <- "https://www.dropbox.com/s/zx0w39gedhcjsib/2019-06-15.json?dl=1"
df <- jsonlite::fromJSON(L, flatten = TRUE) %>%
  as.data.frame()
```

Get the time stamp as a time object.
```{r}
Time <- as_datetime(df$locations.properties.timestamp)
```

Get the spatial coordinates, speed, and convert to a simple feature data frame.
```{r}
Space <- matrix(unlist(df$locations.geometry.coordinates), 
                ncol = 2, 
                byrow = TRUE) %>%
         data.frame()
Speed <- df$locations.properties.speed
Acc <- df$locations.properties.horizontal_accuracy

SpaceTime <- data.frame(lon = Space$X1, 
                        lat = Space$X2, 
                        Time,
                        Hour = hour(Time),
                        Speed,
                        Acc)

df_sf <- st_as_sf(SpaceTime, coords = c("lon", "lat"), 
                  crs = 4326)
```

Make a static map using **tmap**.
```{r}
tmap_mode("view")

tm_shape(df_sf) +
  tm_dots(col = "Acc")

tmap_mode("plot")
```

Make a map using Leaflet, using custom markers.
```{r}
library(leaflet)
m <- leaflet() %>%
  addCircleMarkers(data = df_sf) %>%
 addProviderTiles(providers$CartoDB.Positron)
m  # Print the map
```

Center ggmap near Ian's house.
```{r}
register_google(key = "AIzaSyA7buW39is2slTxrL_Y6wXbkGuPv63RALw")
homework <- get_map(location = c(-71.13, 42.38), maptype = "terrain", source = "google", zoom = 10, API_console_key = "AIzaSyA7buW39is2slTxrL_Y6wXbkGuPv63RALw")
ggmap(homework)
```

See path of Ian's location throughout the day. 
```{r}
ggmap(homework) + geom_path(data = SpaceTime, size = 1)
```

Animate dot of Ian's location throughout the day using gganimate. Some points are outside the range of this map.
```{r}
library(ggmap)
library(ggploty)
library(ggplot2)
library(ggmap)
library(gganimate)
p <- ggmap(homework) + geom_point(data = SpaceTime, size = 1) + transition_time(SpaceTime$Time)
animate(p,nframes = 50, fps = 20) #render
```

Linearly map Ian's location by minute. This creates a dataframe of 1440 entries, one for every minute of the day.
```{r}
aim <- seq(as.POSIXct('2019-06-15 00:00:00'), as.POSIXct('2019-06-15 23:59:59'), by = "mins")
length(aim)
xa <- approx(as.POSIXct(SpaceTime$Time), method="linear", rule=2, SpaceTime$lat, xout=aim)$y
ya <- approx(as.POSIXct(SpaceTime$Time), method="linear", rule=2, SpaceTime$lon, xout=aim)$y

idfi <- as.data.frame(aim)
idfi["lat"] <- xa
idfi["lon"] <- ya
```

Play Ian's minute-by-minute location with a wake effect.
```{r}
p <- ggmap(homework) + geom_point(color="red", fill="grey", data = idfi, size = 4) + transition_time(idfi$aim) + labs(title = "Ian's Location",subtitle = "Time:{frame}", x = "Long", y = "Lat") + shadow_wake(wake_length = 0.10, size=0.5, falloff ="cubic-in", alpha = TRUE, fill="blue") 
p
```

Set the "camera" to follow Ian's location through the day. gganimate takes a list of xmin, xmax, ymin, and ymax values via view_zoom_manual to define the frame. Let's do one frame for each hour. Please let me know if you would do this differently.
```{r}
# Set the bounding boxes such that they are larger than the location point. Important when Ian spends more than an hour in one place. 
idfi <- idfi %>% 
  mutate(xmin = lon - 0.5)
idfi <- idfi  %>% 
  mutate(xmax = lon + 0.5)
idfi <- idfi  %>% 
  mutate(ymin = lat - 0.5)
idfi <- idfi  %>% 
  mutate(ymax = lat + 0.5)

# Find the mean of the bounding box every hour.
xmin <- colMeans(matrix(idfi$xmin, nrow=60))
ymin <- colMeans(matrix(idfi$ymin, nrow=60))
xmax <- colMeans(matrix(idfi$xmax, nrow=60))
ymax <- colMeans(matrix(idfi$ymax, nrow=60))

newResult <- list(xmin = xmin, ymin = ymin, xmax = xmax, ymax = ymax)

zoom <- get_map(location = c( -71.13, 42.38), maptype = "toner", source = "stamen", zoom = 12, force = TRUE)
world<- get_map(location = c( -71.5, 42.38), maptype = "toner", source = "stamen", zoom = 8, force = TRUE)

p <- ggmap(world, API_console_key = "AIzaSyA7buW39is2slTxrL_Y6wXbkGuPv63RALw") +  inset_ggmap(zoom) + geom_point(color="red", fill="grey", data = idfi,aes(y = idfi$lat, x= idfi$lon), size = 4) + transition_time(idfi$aim) + view_zoom_manual(1, 1, xmin = newResult$xmin, xmax = newResult$xmax, ymin = newResult$ymin, ymax = newResult$ymax, wrap = TRUE)
p
```
