---
title: "Ian's World"
author: "Ian and Jim"
output:
  html_document:
editor_options: 
  chunk_output_type: console
---

Packages
```{r}
library(dplyr)
library(tmap)
library(sf)
library(lubridate)
```

Get data from Ian's private location tracking server for June 15, 2019
```{r}
L <- "https://ianandashira.com/api/query?token=IKFDWWpEEJLZmpOrciHNlWE53PnyZScKpAq7nl88&date=2019-06-15"
df <- jsonlite::fromJSON(L, flatten = TRUE) %>%
  as.data.frame()
```

Get the time stamp as a time object.
```{r}
Time <- as_datetime(df$locations.properties.timestamp)
```

Get the spatial coordinates, speed, and convert to a simple feature data frame.
```{r}
Space <- matrix(unlist(df$locations.geometry.coordinates), 
                ncol = 2, 
                byrow = TRUE) %>%
         data.frame()
Speed <- df$locations.properties.speed
Acc <- df$locations.properties.horizontal_accuracy

SpaceTime <- data.frame(Lon = Space$X1, 
                        Lat = Space$X2, 
                        Time,
                        Hour = hour(Time),
                        Speed,
                        Acc)

df_sf <- st_as_sf(SpaceTime, coords = c("Lon", "Lat"), 
                  crs = 4326)
```

Make a static map using **tmap**.
```{r}
tmap_mode("view")

tm_shape(df_sf) +
  tm_dots(col = "Acc")

tmap_mode("plot")
```

Animate the map.
```{r}
anim <- tm_shape(df_sf) +
  tm_dots() +
  tm_facets(along = "Hour", free.coords = FALSE)

tmap_animation(anim, delay = 25)
```

# OSRM package
https://github.com/rCarto/osrm

# cartography package
https://cran.r-project.org/web/packages/cartography/vignettes/cartography.html

Get simple feature data frame and corresponding map tiles from OSM.
```{r}
library(sf)
library(cartography)
# path to the geopackage file embedded in cartography
path_to_gpkg <- system.file("gpkg/mtq.gpkg", package = "cartography")
# import to an sf object
mtq <- st_read(dsn = path_to_gpkg, quiet = TRUE)
# download osm tiles
mtq.osm <- getTiles(
  x = mtq, 
  type = "osm", 
  zoom = 11, 
  crop = TRUE
)
```

Plot only the OSM tiles
```{r}
tilesLayer(x = mtq.osm)
```

Plot the tiles and other layers.
```{r}
tilesLayer(x = mtq.osm)
# plot municipalities (only borders are plotted)
plot(st_geometry(mtq), col = NA, border = "grey", add=TRUE)
# plot population
propSymbolsLayer(
  x = mtq, 
  var = "POP", 
  inches = 0.4, 
  col = "brown4",
  legend.pos = "topright",  
  legend.title.txt = "Total population"
)
# layout
layoutLayer(title = "Population Distribution in Martinique",
            sources = "Sources: Insee and IGN, 2018\nÂ© OpenStreetMap contributors.\nTiles style under CC BY-SA, www.openstreetmap.org/copyright.",
            author = paste0("cartography ", packageVersion("cartography")),
            frame = FALSE, north = FALSE, tabtitle = TRUE)
# north arrow
north(pos = "topleft")
```