---
title: "Ian's World"
author: "Ian and Jim"
output:
  html_document:
editor_options: 
  chunk_output_type: console
---

Packages
```{r}
library(dplyr)
library(tmap)
library(sf)
library(lubridate)
```

Get data from Ian's private location tracking server for June 15, 2019. Changed to hosted file to hide API key.
```{r}
L <- "https://www.dropbox.com/s/zx0w39gedhcjsib/2019-06-15.json?dl=1"
df <- jsonlite::fromJSON(L, flatten = TRUE) %>%
  as.data.frame()
```

Get the time stamp as a time object.
```{r}
Time <- as_datetime(df$locations.properties.timestamp)
```

Get the spatial coordinates, speed, and convert to a simple feature data frame.
```{r}
Space <- matrix(unlist(df$locations.geometry.coordinates), 
                ncol = 2, 
                byrow = TRUE) %>%
         data.frame()
Speed <- df$locations.properties.speed
Acc <- df$locations.properties.horizontal_accuracy

SpaceTime <- data.frame(Lon = Space$X1, 
                        Lat = Space$X2, 
                        Time,
                        Hour = hour(Time),
                        Speed,
                        Acc)

df_sf <- st_as_sf(SpaceTime, coords = c("Lon", "Lat"), 
                  crs = 4326)
```

Make a static map using **tmap**.
```{r}
tmap_mode("view")

tm_shape(df_sf) +
  tm_dots(col = "Acc")

tmap_mode("plot")
```

Make a map using Leaflet, using custom markers.
```{r}
library(leaflet)
m <- leaflet() %>%
  addCircleMarkers(data = df_sf) %>%
 addProviderTiles(providers$CartoDB.Positron)
m  # Print the map
```

There's a Leaflet plugin called LeafletPlayback that does almost exactly what we're trying to do. You can find it at https://github.com/hallahan/LeafletPlayback

Here's a way to load the Leaflet plugin in R. From: https://segmentfault.com/a/1190000013495709

In this example, you can see Ian's static location data and (on the Oregon coast) the demo tracks.
```{r}
library(htmltools)
library(htmlwidgets)


LeafletPlaybackPlugin <-
  htmlDependency(
    "LeafletPlayback",
    "1.0.0",
    src = c(href ="http://leafletplayback.theoutpost.io/"),
    script = c("dist/LeafletPlayback.js", "data/demo/demo-tracks.js")
  )

registerPlugin <- function(map, plugin) {
  map$dependencies <- c(map$dependencies, list(plugin))
  map
}


leaflet() %>%
  addCircleMarkers(data = df_sf) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  registerPlugin(LeafletPlaybackPlugin) %>%
  onRender(
    "
    function(el, x) {
      var playbackOptions = {
        playControl: true,
        dateControl: true,
        sliderControl: true     
      };
      var playback = new L.playback(this, demoTracks, null, playbackOptions); 
    } "
)
```

LeafletPlayback requires a GeoJSON file to work. Converting from sf to GeoJSON is possible with geojsonio. 
```{r}
library(geojsonio)
df_sfc <- st_cast(df_sf, "MULTIPOINT", group_or_split=TRUE, agr = "constant")
df_geo <- geojson_json(df_sfc)
head(df_geo)
```

However, LeafletPlayback requires a very specific type of GeoJSON to work:
{
  "type": "Feature",
  "geometry": {
    "type": "MultiPoint",
    "coordinates": [/*array of [lng,lat] coordinates*/]
  },
  "properties": {
    "time": [/*array of UNIX timestamps*/]
  }
}

Another unsuccessful attempt.
```{r}
geojsontest1<- geojson_list(st_combine(df_sf$geometry))
geojsontest2<- geojson_list(df_sf$time)
geojsontest <- geojsontest1 + geojsontest2

df_geo <- geojson_json(geojsontest, type = "FeatureCollection")

```

I created my own GeoJSON file in this directory that matches the parameters that LeafletPlayback uses: /ian.geojson 
You can upload it here to see the LeafletPlayback working with my data: http://leafletplayback.theoutpost.io/examples/example_2.html


Animate the map.
```{r}
anim <- tm_shape(df_sf) +
  tm_dots() +
  tm_facets(along = "Hour", free.coords = FALSE)

tmap_animation(anim, delay = 25)
```

# OSRM package
https://github.com/rCarto/osrm

# cartography package
https://cran.r-project.org/web/packages/cartography/vignettes/cartography.html

Get simple feature data frame and corresponding map tiles from OSM.
```{r}
library(sf)
library(cartography)
# path to the geopackage file embedded in cartography
path_to_gpkg <- system.file("gpkg/mtq.gpkg", package = "cartography")
# import to an sf object
mtq <- st_read(dsn = path_to_gpkg, quiet = TRUE)
# download osm tiles
mtq.osm <- getTiles(
  x = mtq, 
  type = "osm", 
  zoom = 11, 
  crop = TRUE
)
```

Plot only the OSM tiles
```{r}
tilesLayer(x = mtq.osm)
```

Plot the tiles and other layers.
```{r}
tilesLayer(x = mtq.osm)
# plot municipalities (only borders are plotted)
plot(st_geometry(mtq), col = NA, border = "grey", add=TRUE)
# plot population
propSymbolsLayer(
  x = mtq, 
  var = "POP", 
  inches = 0.4, 
  col = "brown4",
  legend.pos = "topright",  
  legend.title.txt = "Total population"
)
# layout
layoutLayer(title = "Population Distribution in Martinique",
            sources = "Sources: Insee and IGN, 2018\nÂ© OpenStreetMap contributors.\nTiles style under CC BY-SA, www.openstreetmap.org/copyright.",
            author = paste0("cartography ", packageVersion("cartography")),
            frame = FALSE, north = FALSE, tabtitle = TRUE)
# north arrow
north(pos = "topleft")
```